<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SoulRoom ğŸ’–</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#fff0f5}
#login,#incoming{position:fixed;inset:0;display:flex;justify-content:center;align-items:center}
#chat,#video{display:none;height:100vh;flex-direction:column}
.card{background:#fff;padding:20px;border-radius:16px;width:90%;max-width:360px}
input,button{padding:14px;border-radius:12px;border:none;width:100%;margin-top:10px}
button{background:#ff5c8a;color:#fff;font-weight:bold}
.header{background:#ff5c8a;color:#fff;padding:12px;display:flex;justify-content:space-between}
.messages{flex:1;overflow:auto;padding:10px}
.msg{padding:10px;border-radius:14px;margin:6px;max-width:70%}
.me{background:#ff5c8a;color:#fff;margin-left:auto}
.you{background:#eee}
#incoming{display:none;background:rgba(0,0,0,.8);color:#fff;z-index:10}
#incoming .box{background:#222;padding:20px;border-radius:14px;width:260px;text-align:center}
#video{background:#000;flex-direction:row}
video{width:50%;height:100%;object-fit:cover}
</style>
</head>

<body>

<div id="login">
  <div class="card">
    <h3>SoulRoom ğŸ”</h3>
    <input id="name" placeholder="Your name">
    <input id="pin" placeholder="PIN">
    <button id="enter">Enter</button>
  </div>
</div>

<div id="chat">
  <div class="header">
    <span>OnlyUs ğŸ’–</span>
    <button id="call">ğŸ“</button>
  </div>
  <div class="messages" id="msgs"></div>
  <div style="display:flex;padding:8px;gap:8px">
    <input id="text" style="flex:1;padding:14px">
    <button id="send">Send</button>
  </div>
</div>

<div id="incoming">
  <div class="box">
    <h3>ğŸ“ Incoming Call</h3>
    <p id="caller"></p>
    <button id="accept">Accept</button>
    <button id="reject">Reject</button>
  </div>
</div>

<div id="video">
  <video id="local" autoplay muted playsinline></video>
  <video id="remote" autoplay playsinline></video>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAdpLNU2c-C5KxJv2weJECSpoghz_NGNtM",
  databaseURL:"https://soulroom-4e31d-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();
const room=new URLSearchParams(location.search).get("room")||"love";

const nameInput=document.getElementById("name");
const pinInput=document.getElementById("pin");
const enterBtn=document.getElementById("enter");
const sendBtn=document.getElementById("send");
const callBtn=document.getElementById("call");

let user, pc, localStream;
const cfg={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

enterBtn.onclick=()=>{
  if(!nameInput.value || !pinInput.value){
    alert("Fill all fields");
    return;
  }
  user=nameInput.value.trim();
  login.style.display="none";
  chat.style.display="flex";
  listenChat();
  listenCall();
};

sendBtn.onclick=()=>{
  if(!text.value)return;
  db.ref(`rooms/${room}/msgs`).push({u:user,t:text.value});
  text.value="";
};

function listenChat(){
  db.ref(`rooms/${room}/msgs`).on("child_added",s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="msg "+(m.u===user?"me":"you");
    d.innerText=m.t;
    msgs.appendChild(d);
    msgs.scrollTop=msgs.scrollHeight;
  });
}

callBtn.onclick=()=>{
  db.ref(`calls/${room}`).set({from:user,status:"ringing"});
};

function listenCall(){
  db.ref(`calls/${room}`).on("value",async s=>{
    const c=s.val();
    if(!c)return;
    if(c.status==="ringing" && c.from!==user){
      caller.innerText=c.from+" is callingâ€¦";
      incoming.style.display="flex";
    }
    if(c.status==="accepted" && c.from===user){
      startPeer(true);
    }
  });
}

accept.onclick=async ()=>{
  await db.ref(`calls/${room}`).update({status:"accepted"});
  incoming.style.display="none";
  startPeer(false);
};

reject.onclick=()=>{
  db.ref(`calls/${room}`).remove();
  incoming.style.display="none";
};

async function startPeer(isCaller){
  chat.style.display="none";
  video.style.display="flex";

  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  local.srcObject=localStream;

  pc=new RTCPeerConnection(cfg);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack=e=>remote.srcObject=e.streams[0];
  pc.onicecandidate=e=>{
    if(e.candidate){
      db.ref(`calls/${room}/ice`).push({by:user,c:e.candidate});
    }
  };

  if(isCaller){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    db.ref(`calls/${room}/offer`).set(offer);
  }
}

db.ref(`calls/${room}/offer`).on("value",async s=>{
  if(!s.exists()||pc)return;
  await startPeer(false);
  await pc.setRemoteDescription(new RTCSessionDescription(s.val()));
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  db.ref(`calls/${room}/answer`).set(ans);
});

db.ref(`calls/${room}/answer`).on("value",async s=>{
  if(s.exists()&&pc&&!pc.currentRemoteDescription){
    await pc.setRemoteDescription(new RTCSessionDescription(s.val()));
  }
});

db.ref(`calls/${room}/ice`).on("child_added",s=>{
  const d=s.val();
  if(pc&&d.by!==user){
    pc.addIceCandidate(new RTCIceCandidate(d.c));
  }
});
</script>
</body>
</html>
