<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SoulRoom üíñ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#fff0f5}

/* LOGIN */
#login{height:100vh;display:flex;justify-content:center;align-items:center}
.card{background:#fff;padding:22px;border-radius:18px;width:90%;max-width:360px}
input,button{padding:14px;border-radius:12px;border:none;width:100%;margin-top:10px}
button{background:#ff5c8a;color:#fff;font-weight:bold}

/* CHAT */
#chat{display:none;height:100vh;flex-direction:column}
.header{background:#ff5c8a;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.messages{flex:1;overflow:auto;padding:10px}
.msg{padding:10px;border-radius:14px;margin:6px;max-width:70%}
.me{background:#ff5c8a;color:#fff;margin-left:auto}
.you{background:#eee}

/* INPUT BAR */
.inputBar{display:flex;padding:8px;gap:8px}
#msgInput{flex:1;font-size:16px;padding:14px}
#sendBtn{width:70px}

/* INCOMING CALL */
#incoming{
position:fixed;inset:0;display:none;
justify-content:center;align-items:center;
background:rgba(0,0,0,.85);z-index:99;color:#fff;
}
#incoming .box{
background:#222;padding:22px;border-radius:16px;
text-align:center;width:260px;
}

/* VIDEO CALL */
#videoCall{
display:none;
background:#000;
height:100vh;
width:100vw;
flex-direction:row;
}
video{
width:50%;
height:100%;
object-fit:cover;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h3>SoulRoom üîê</h3>
    <input id="nameInput" placeholder="Your name">
    <input id="pinInput" placeholder="PIN">
    <button id="enterBtn">Enter</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header">
    <span>OnlyUs üíñ</span>
    <button id="callBtn">üìû</button>
  </div>

  <div id="messages" class="messages"></div>

  <div class="inputBar">
    <input id="msgInput" placeholder="Type message‚Ä¶">
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- INCOMING CALL -->
<div id="incoming">
  <div class="box">
    <h3>üìû Incoming Call</h3>
    <p id="callerText"></p>
    <button id="acceptBtn">Accept</button>
    <button id="rejectBtn">Reject</button>
  </div>
</div>

<!-- VIDEO -->
<div id="videoCall">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAdpLNU2c-C5KxJv2weJECSpoghz_NGNtM",
  databaseURL:"https://soulroom-4e31d-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();
const room=new URLSearchParams(location.search).get("room")||"love";

/* DOM */
const login=document.getElementById("login");
const chat=document.getElementById("chat");
const messages=document.getElementById("messages");
const incoming=document.getElementById("incoming");
const videoCall=document.getElementById("videoCall");

const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");

const nameInput=document.getElementById("nameInput");
const pinInput=document.getElementById("pinInput");
const msgInput=document.getElementById("msgInput");
const callerText=document.getElementById("callerText");

let user, pc, localStream;

/* LOGIN */
enterBtn.onclick=()=>{
  user=nameInput.value.trim();
  if(!user||!pinInput.value.trim()) return alert("Fill all fields");
  login.style.display="none";
  chat.style.display="flex";
  listenMessages();
  listenCalls();
};

/* CHAT */
sendBtn.onclick=()=>{
  if(!msgInput.value.trim())return;
  db.ref(`rooms/${room}/msgs`).push({u:user,t:msgInput.value});
  msgInput.value="";
};

function listenMessages(){
  db.ref(`rooms/${room}/msgs`).on("child_added",s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="msg "+(m.u===user?"me":"you");
    d.innerText=m.t;
    messages.appendChild(d);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* CALL */
callBtn.onclick=()=>{
  db.ref(`calls/${room}`).set({from:user,status:"ringing"});
};

function listenCalls(){
  db.ref(`calls/${room}`).on("value",async s=>{
    const c=s.val();
    if(!c) return;

    if(c.status==="ringing" && c.from!==user){
      callerText.innerText=c.from+" is calling‚Ä¶";
      incoming.style.display="flex";
    }

    if(c.status==="accepted"){
      incoming.style.display="none";
      if(c.from===user) startVideo(true);
    }
  });
}

/* ACCEPT / REJECT */
acceptBtn.onclick=async ()=>{
  await db.ref(`calls/${room}`).update({status:"accepted"});
  incoming.style.display="none";
  startVideo(false);
};
rejectBtn.onclick=()=>{
  db.ref(`calls/${room}`).remove();
  incoming.style.display="none";
};

/* WEBRTC */
const rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function startVideo(isCaller){
  chat.style.display="none";
  videoCall.style.display="flex";

  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;

  pc=new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];
  pc.onicecandidate=e=>{
    if(e.candidate){
      db.ref(`calls/${room}/ice`).push({by:user,c:e.candidate});
    }
  };

  if(isCaller){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    db.ref(`calls/${room}/offer`).set(offer);
  }
}

/* SIGNALING */
db.ref(`calls/${room}/offer`).on("value",async s=>{
  if(!s.exists()||pc) return;
  await startVideo(false);
  await pc.setRemoteDescription(new RTCSessionDescription(s.val()));
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  db.ref(`calls/${room}/answer`).set(ans);
});

db.ref(`calls/${room}/answer`).on("value",async s=>{
  if(s.exists()&&pc&&!pc.currentRemoteDescription){
    await pc.setRemoteDescription(new RTCSessionDescription(s.val()));
  }
});

db.ref(`calls/${room}/ice`).on("child_added",s=>{
  const d=s.val();
  if(pc&&d.by!==user){
    pc.addIceCandidate(new RTCIceCandidate(d.c));
  }
});

});
</script>
</body>
</html>
