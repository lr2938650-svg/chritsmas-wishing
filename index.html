<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SoulRoom ğŸ’–</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#fff0f5}
#login,#chat{height:100vh}
#login{display:flex;justify-content:center;align-items:center}
.card{background:#fff;padding:24px;border-radius:18px;width:90%;max-width:360px}
input,button{width:100%;padding:14px;margin-top:12px;border-radius:12px;border:none}
button{background:#ff5c8a;color:#fff;font-weight:bold}

#chat{display:none;flex-direction:column}
.header{background:#ff5c8a;color:#fff;padding:12px;display:flex;justify-content:space-between}
.messages{flex:1;overflow:auto;padding:10px}
.msg{padding:10px;border-radius:14px;margin:5px;max-width:70%}
.me{background:#ff5c8a;color:#fff;margin-left:auto}
.you{background:#eee}

.inputBar{display:flex;gap:6px;padding:8px}

.icon{width:44px;border-radius:50%}

#incoming,#video{
  position:fixed;inset:0;
  display:none;justify-content:center;align-items:center;
}
#incoming{background:rgba(0,0,0,.8);color:#fff}
#incoming .box{background:#222;padding:20px;border-radius:15px;text-align:center}

#video{background:#000;flex-direction:column}
video{width:100%;height:45%;object-fit:cover}
.end{background:red}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h3>SoulRoom ğŸ”</h3>
    <input id="nameInput" placeholder="Your name">
    <input id="pinInput" placeholder="PIN">
    <button id="enterBtn">Enter</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header">
    <span>OnlyUs ğŸ’–</span>
    <button class="icon" id="callBtn">ğŸ“</button>
  </div>

  <div class="messages" id="messages"></div>

  <div class="inputBar">
    <input id="msgInput" placeholder="Type message">
    <button id="sendBtn">â¤</button>
  </div>
</div>

<!-- INCOMING CALL -->
<div id="incoming">
  <div class="box">
    <h3>ğŸ“ Incoming Call</h3>
    <button id="acceptBtn">Accept</button>
    <button id="rejectBtn">Reject</button>
  </div>
</div>

<!-- VIDEO -->
<div id="video">
  <video id="remoteVideo" autoplay></video>
  <video id="localVideo" autoplay muted></video>
  <button class="icon end" id="endBtn">âŒ</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAdpLNU2c-C5KxJv2weJECSpoghz_NGNtM",
  databaseURL:"https://soulroom-4e31d-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();

/* ğŸ”¥ DOM */
const loginDiv=document.getElementById("login");
const chatDiv=document.getElementById("chat");
const incoming=document.getElementById("incoming");
const videoBox=document.getElementById("video");

const nameInput=document.getElementById("nameInput");
const pinInput=document.getElementById("pinInput");
const msgInput=document.getElementById("msgInput");
const messages=document.getElementById("messages");

const enterBtn=document.getElementById("enterBtn");
const sendBtn=document.getElementById("sendBtn");
const callBtn=document.getElementById("callBtn");
const acceptBtn=document.getElementById("acceptBtn");
const rejectBtn=document.getElementById("rejectBtn");
const endBtn=document.getElementById("endBtn");

const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");

/* ğŸ”¥ STATE */
const room=new URLSearchParams(location.search).get("room")||"love";
let user,pc,stream,isCaller=false;
const rtcCfg={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

/* ğŸ” LOGIN */
enterBtn.onclick=()=>{
  user=nameInput.value.trim();
  if(!user||!pinInput.value.trim()){
    alert("Fill all fields");
    return;
  }
  loginDiv.style.display="none";
  chatDiv.style.display="flex";
  listenMessages();
  listenCalls();
};

/* ğŸ’¬ CHAT */
sendBtn.onclick=()=>{
  if(!msgInput.value) return;
  db.ref(`rooms/${room}/msgs`).push({u:user,t:msgInput.value});
  msgInput.value="";
};

function listenMessages(){
  db.ref(`rooms/${room}/msgs`).on("child_added",s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="msg "+(m.u===user?"me":"you");
    d.innerText=m.t;
    messages.appendChild(d);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* ğŸ“ CALL */
callBtn.onclick=async ()=>{
  isCaller=true;
  await startMedia();
  pc=createPC();

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  db.ref(`calls/${room}`).set({
    from:user,
    offer:offer,
    status:"ringing"
  });

  videoBox.style.display="flex";
};

function listenCalls(){
  db.ref(`calls/${room}`).on("value",async s=>{
    const c=s.val();
    if(!c) return;

    if(c.status==="ringing" && c.from!==user){
      incoming.style.display="flex";
    }

    if(c.answer && isCaller){
      await pc.setRemoteDescription(c.answer);
    }
  });
}

acceptBtn.onclick=async ()=>{
  incoming.style.display="none";
  await startMedia();
  pc=createPC();

  const snap=await db.ref(`calls/${room}/offer`).once("value");
  await pc.setRemoteDescription(snap.val());

  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);

  db.ref(`calls/${room}`).update({answer:ans,status:"connected"});
  videoBox.style.display="flex";
};

rejectBtn.onclick=()=>{
  db.ref(`calls/${room}`).remove();
  incoming.style.display="none";
};

endBtn.onclick=()=>{
  if(pc) pc.close();
  if(stream) stream.getTracks().forEach(t=>t.stop());
  db.ref(`calls/${room}`).remove();
  videoBox.style.display="none";
  isCaller=false;
};

function createPC(){
  const pc=new RTCPeerConnection(rtcCfg);
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];
  pc.onicecandidate=e=>{
    if(e.candidate)
      db.ref(`calls/${room}/ice`).push(e.candidate.toJSON());
  };
  db.ref(`calls/${room}/ice`).on("child_added",s=>{
    pc.addIceCandidate(new RTCIceCandidate(s.val()));
  });
  return pc;
}

async function startMedia(){
  stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=stream;
}
</script>
</body>
</html>
