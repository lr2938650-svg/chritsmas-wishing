<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SoulRoom ğŸ’–</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#fff0f5}
#login,#incoming{height:100vh;display:flex;justify-content:center;align-items:center}
.card{background:#fff;padding:20px;border-radius:16px;width:90%;max-width:360px}
input,button{padding:14px;border-radius:12px;border:none;font-size:16px}
button{background:#ff5c8a;color:#fff;font-weight:bold}

#chat{display:none;height:100vh;flex-direction:column}
.header{background:#ff5c8a;color:#fff;padding:10px;display:flex;justify-content:space-between}
.messages{flex:1;overflow:auto;padding:10px}
.msg{padding:10px;border-radius:12px;margin:6px;max-width:70%}
.me{background:#ff5c8a;color:#fff;margin-left:auto}
.you{background:#eee}

.inputBar{display:flex;gap:8px;padding:8px}
#msgInput{flex:1}
#sendBtn{width:70px}

#incoming{
display:none;position:fixed;inset:0;
background:rgba(0,0,0,.85);z-index:99;color:#fff
}
#incoming .card{background:#222;text-align:center}

#videos{
display:none;
position:fixed;inset:0;
background:#000;z-index:100
}
video{width:50%;height:100%;object-fit:cover}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h3>SoulRoom ğŸ”</h3>
    <input id="nameInput" placeholder="Your name">
    <input id="pinInput" placeholder="PIN">
    <button id="enterBtn">Enter</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header">
    <span>OnlyUs ğŸ’–</span>
    <button id="callBtn">ğŸ“</button>
  </div>

  <div id="messages" class="messages"></div>

  <div class="inputBar">
    <input id="msgInput" placeholder="Type messageâ€¦">
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- INCOMING -->
<div id="incoming">
  <div class="card">
    <h3>ğŸ“ Incoming Call</h3>
    <p id="callerText"></p>
    <button id="acceptBtn">Accept</button>
    <button id="rejectBtn">Reject</button>
  </div>
</div>

<!-- VIDEO -->
<div id="videos">
  <video id="local" autoplay muted playsinline></video>
  <video id="remote" autoplay playsinline></video>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAdpLNU2c-C5KxJv2weJECSpoghz_NGNtM",
  databaseURL:"https://soulroom-4e31d-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=firebase.database();
const room=new URLSearchParams(location.search).get("room")||"love";

const login=document.getElementById("login");
const chat=document.getElementById("chat");
const incoming=document.getElementById("incoming");
const videos=document.getElementById("videos");

const local=document.getElementById("local");
const remote=document.getElementById("remote");

let user,pc,localStream;

const cfg={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

function msg(t,me){
  const d=document.createElement("div");
  d.className="msg "+(me?"me":"you");
  d.innerText=t;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

async function createPeer(){
  pc=new RTCPeerConnection(cfg);

  pc.ontrack=e=>{
    remote.srcObject=e.streams[0];
  };

  pc.onicecandidate=e=>{
    if(e.candidate){
      db.ref(`calls/${room}/ice`).push({by:user,c:e.candidate});
    }
  };

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

/* LOGIN */
enterBtn.onclick=()=>{
  user=nameInput.value.trim();
  if(!user||!pinInput.value.trim()) return alert("Fill all");
  login.style.display="none";
  chat.style.display="flex";

  db.ref(`rooms/${room}/msgs`).on("child_added",s=>{
    const m=s.val();
    msg(m.t,m.u===user);
  });

  db.ref(`calls/${room}`).on("value",s=>{
    const c=s.val();
    if(!c) return;

    if(c.status==="ringing" && c.from!==user){
      callerText.innerText=c.from+" is callingâ€¦";
      incoming.style.display="flex";
    }

    if(c.answer && pc && !pc.currentRemoteDescription){
      pc.setRemoteDescription(new RTCSessionDescription(c.answer));
      videos.style.display="flex";
    }
  });

  db.ref(`calls/${room}/ice`).on("child_added",s=>{
    const d=s.val();
    if(pc && d.by!==user){
      pc.addIceCandidate(new RTCIceCandidate(d.c));
    }
  });
};

/* SEND */
sendBtn.onclick=()=>{
  if(!msgInput.value.trim())return;
  db.ref(`rooms/${room}/msgs`).push({u:user,t:msgInput.value});
  msgInput.value="";
};

/* CALL */
callBtn.onclick=async()=>{
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  local.srcObject=localStream;

  await createPeer();
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);

  db.ref(`calls/${room}`).set({
    from:user,
    status:"ringing",
    offer:offer
  });
};

/* ACCEPT */
acceptBtn.onclick=async()=>{
  incoming.style.display="none";

  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  local.srcObject=localStream;

  await createPeer();

  const snap=await db.ref(`calls/${room}/offer`).get();
  await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));

  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);

  db.ref(`calls/${room}`).update({
    status:"accepted",
    answer:answer
  });

  videos.style.display="flex";
};

/* REJECT */
rejectBtn.onclick=()=>{
  incoming.style.display="none";
  db.ref(`calls/${room}`).remove();
};
</script>
</body>
</html>
