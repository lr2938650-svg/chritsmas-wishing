<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Private Chat Room üí¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* RESET + BODY */
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:'Helvetica Neue',sans-serif;
  background:#0b141a;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* JOIN SCREEN */
#join{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  flex:1;
  padding:20px;
}
#join h2{
  margin-bottom:20px;
  font-size:28px;
  font-weight:bold;
  color:#25d366;
  text-align:center;
}
#join input{
  width:100%;
  max-width:360px;
  margin:10px 0;
  padding:14px 18px;
  border-radius:25px;
  border:none;
  font-size:16px;
}
#join button{
  width:100%;
  max-width:360px;
  margin-top:15px;
  padding:14px 0;
  border-radius:25px;
  border:none;
  font-size:16px;
  font-weight:bold;
  background:#25d366;
  color:#000;
  cursor:pointer;
  transition:0.2s;
}
#join button:hover{background:#1ebe57;}

/* CHAT SCREEN */
#chat{display:flex;flex-direction:column;height:100%;width:100%;}

/* HEADER */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#202c33;
  padding:12px 15px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  flex-shrink:0;
}
header span{
  font-weight:bold;
  font-size:18px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:55%;
}
header .header-buttons{display:flex;gap:8px;}
header button{
  background:#25d366;
  color:#000;
  border:none;
  border-radius:12px;
  padding:8px 12px;
  cursor:pointer;
  font-size:16px;
  flex-shrink:0;
}
header button:hover{background:#1ebe57;}

/* MESSAGES AREA */
#messages{
  flex:1;
  overflow-y:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
  background:#111b22;
  scroll-behavior:smooth;
}

/* MESSAGE BUBBLES */
.msg{
  max-width:75%;
  padding:12px 16px;
  border-radius:22px;
  word-wrap:break-word;
  font-size:15px;
  line-height:1.4;
  animation:fadeIn 0.2s ease;
  word-break:break-word;
}
.me{align-self:flex-end;background:#25d366;color:#000;border-bottom-right-radius:6px;}
.other{align-self:flex-start;background:#2a2f33;color:#fff;border-bottom-left-radius:6px;}
.msg img{max-width:100%;border-radius:12px;display:block;margin-top:5px;}

/* FOOTER INPUT BAR */
footer{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px;
  background:#202c33;
  flex-shrink:0;
}
footer input[type="text"]{
  flex:1;
  border-radius:25px;
  padding:12px 16px;
  font-size:15px;
  border:none;
  outline:none;
  background:#111b22;
  color:#fff;
}
footer button{
  width:50px;
  height:50px;
  border-radius:50%;
  font-size:20px;
  background:#25d366;
  color:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  border:none;
  flex-shrink:0;
}
footer button:hover{background:#1ebe57;}

/* VIDEO ELEMENTS */
.video-container{
  display:flex;
  justify-content:space-between;
  padding:5px 10px;
  gap:5px;
  flex-wrap:wrap;
}
video{
  flex:1 1 48%;
  max-height:220px;
  border-radius:12px;
  background:#000;
}

/* POPUPS */
#popup,#lock{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.popupBox{
  background:#202c33;
  padding:25px;
  border-radius:18px;
  text-align:center;
  width:90%;
  max-width:380px;
}
.popupBox h3{margin-bottom:15px;color:#25d366;font-size:20px;}
.popupBox p{margin-bottom:15px;font-size:14px;color:#ccc;}
.popupBox button{
  padding:12px 18px;
  margin:8px 6px;
  width:45%;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
.popupBox button:hover{background:#1ebe57;}

/* BLUR ON LOCK */
.blur{filter:blur(8px);}

/* ANIMATIONS */
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}

/* MOBILE RESPONSIVE */
@media(max-width:480px){
  header span{font-size:16px;max-width:50%;}
  .msg{font-size:14px;max-width:80%;}
  footer button{width:45px;height:45px;font-size:18px;}
  footer input[type="text"]{font-size:14px;padding:10px 14px;}
  video{flex:1 1 100%;max-height:180px;}
  .video-container{padding:5px;}
  #join h2{font-size:24px;}
}
</style>
</head>

<body>

<!-- JOIN SCREEN -->
<div id="join">
<h2>Private Chat Room</h2>
<input id="name" placeholder="Your Name">
<input id="room" placeholder="Secret Code">
<button onclick="joinRoom()">ENTER</button>
</div>

<!-- CHAT SCREEN -->
<div id="chat">
<header>
<span id="roomTitle">Room</span>
<div class="header-buttons">
<button onclick="startCall()">üìû Call</button>
<button onclick="endCall()">‚ùå End</button>
</div>
</header>

<div id="messages"></div>

<footer>
<input id="text" placeholder="Type a message...">
<input type="file" id="img" accept="image/*">
<button onclick="send()">‚û§</button>
</footer>

<div class="video-container">
<video id="local" autoplay playsinline muted></video>
<video id="remote" autoplay playsinline></video>
</div>
</div>

<!-- INCOMING CALL POPUP -->
<div id="popup">
<div class="popupBox">
<h3>Incoming Call</h3>
<button onclick="acceptCall()">Accept</button>
<button onclick="rejectCall()">Reject</button>
</div>
</div>

<!-- SESSION LOCK POPUP -->
<div id="lock">
<div class="popupBox">
<h3>üîí Session Locked</h3>
<p>Tab switched / app backgrounded</p>
<button onclick="unlock()">Unlock</button>
</div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// üî• FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDHYZDkcI0d7bm5CxXtSJQRhlhTkqL1Piw",
  authDomain: "onlyus-44a12.firebaseapp.com",
  databaseURL: "https://onlyus-44a12-default-rtdb.firebaseio.com",
  projectId: "onlyus-44a12",
  storageBucket: "onlyus-44a12.firebasestorage.app",
  messagingSenderId: "808673364331",
  appId: "1:808673364331:web:7e83c562a956f90a13e42e",
  measurementId: "G-XQ34217SR2"
};
firebase.initializeApp(firebaseConfig);

/* VARIABLES */
let me,room,pc,localStream,msgRef,callRef;
const joinDiv=document.getElementById("join");
const chatDiv=document.getElementById("chat");
const popup=document.getElementById("popup");
const lockDiv=document.getElementById("lock");

/* JOIN ROOM */
function joinRoom(){
  const nameInput=document.getElementById("name").value.trim();
  const roomInput=document.getElementById("room").value.trim();
  if(!nameInput || !roomInput) return alert("Fill all fields");

  me=nameInput;
  room=roomInput;
  joinDiv.style.display="none";
  chatDiv.style.display="flex";
  document.getElementById("roomTitle").innerText=room;

  msgRef=firebase.database().ref("rooms/"+room+"/msgs");
  callRef=firebase.database().ref("rooms/"+room+"/call");

  listenMsgs();
  listenCall();
}

/* SEND MESSAGE / IMAGE */
function send(){
  const text=document.getElementById("text").value.trim();
  if(text){
    msgRef.push({from:me,text,seen:false});
    document.getElementById("text").value="";
  }
  const file=document.getElementById("img").files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      const key=msgRef.push({from:me,img:e.target.result}).key;
      setTimeout(()=>msgRef.child(key).remove(),60000);
    };
    reader.readAsDataURL(file);
    document.getElementById("img").value="";
  }
}

/* LISTEN MESSAGES */
function listenMsgs(){
  msgRef.on("child_added",snap=>{
    const m=snap.val();
    const div=document.createElement("div");
    div.className="msg "+(m.from==me?"me":"other");
    div.innerHTML=m.text||`<img src="${m.img}">`;
    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop=9999;
  });
}

/* WEBRTC + MULTI TURN CONFIG */
const pcConfig={
  iceServers:[
    {urls:"stun:stun.l.google.com:19302"},
    {urls:"stun:stun1.l.google.com:19302"},
    {urls:"turn:openrelay.metered.ca:443",username:"openrelayproject",credential:"openrelayproject"},
    {urls:"turn:openrelay.metered.ca:443?transport=tcp",username:"openrelayproject",credential:"openrelayproject"}
  ]
};

/* START CALL */
async function startCall(){
  await setupPC();
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  callRef.set({from:me,type:"offer",sdp:offer,status:"calling"});
}

/* ACCEPT CALL */
async function acceptCall(){
  popup.style.display="none";
  await setupPC();
  const snap=await callRef.once("value");
  const offer=snap.val().sdp;
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  callRef.update({type:"answer",sdp:ans,status:"connected"});
}

/* REJECT CALL */
function rejectCall(){popup.style.display="none";callRef.update({status:"rejected"});}

/* END CALL */
function endCall(){if(localStream) localStream.getTracks().forEach(t=>t.stop()); callRef.set({status:"ended"});}

/* SETUP PEER CONNECTION */
async function setupPC(){
  pc=new RTCPeerConnection(pcConfig);
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById("local").srcObject=localStream;
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack=e=>document.getElementById("remote").srcObject=e.streams[0];
  pc.onicecandidate=e=>{
    if(e.candidate) callRef.child("ice").push(e.candidate.toJSON());
  };
}

/* LISTEN CALL */
function listenCall(){
  callRef.on("value",snap=>{
    const c=snap.val();
    if(!c) return;
    if(c.status=="calling" && c.from!=me) popup.style.display="flex";
    if(c.type=="answer" && c.from!=me) pc.setRemoteDescription(new RTCSessionDescription(c.sdp));
  });
  callRef.child("ice").on("child_added",snap=>{
    if(pc) pc.addIceCandidate(snap.val());
  });
}

/* SESSION LOCK */
document.addEventListener("visibilitychange",()=>{
  document.body.classList.toggle("blur",document.hidden);
  lockDiv.style.display=document.hidden?"flex":"none";
});
function unlock(){ lockDiv.style.display="none"; document.body.classList.remove("blur"); }

</script>
</body>
</html>
