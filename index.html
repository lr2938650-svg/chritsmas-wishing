<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OnlyUs üíñ Video Call</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#fff0f5}
button{background:#ff5c8a;color:#fff;border:none;border-radius:12px;padding:12px;font-weight:bold}
input{padding:14px;border-radius:12px;border:1px solid #ddd;width:100%}

/* LOGIN */
#login{height:100vh;display:flex;justify-content:center;align-items:center}
.card{background:#fff;padding:22px;border-radius:18px;width:90%;max-width:360px}

/* CHAT */
#chat{display:none;height:100vh;flex-direction:column}
.header{background:#ff5c8a;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.messages{flex:1;overflow:auto;padding:10px}
.msg{padding:10px;border-radius:14px;margin:6px;max-width:70%}
.me{background:#ff5c8a;color:#fff;margin-left:auto}
.you{background:#eee}

/* INPUT */
.inputBar{display:flex;gap:8px;padding:8px}
#msgInput{flex:1;font-size:16px}

/* VIDEO */
#videoBox{
display:none;
position:fixed;
inset:0;
background:#000;
z-index:99;
}
video{
width:100%;
height:50%;
object-fit:cover;
background:#000;
}
#endCall{
position:absolute;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:red;
}

/* INCOMING */
#incoming{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.85);
z-index:100;
color:#fff;
justify-content:center;
align-items:center;
}
#incoming .box{
background:#222;
padding:20px;
border-radius:16px;
text-align:center;
width:260px;
}
#incoming button{width:100%;margin-top:10px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <h3>OnlyUs üîê</h3>
    <input id="nameInput" placeholder="Your name">
    <button id="enterBtn">Enter</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat">
  <div class="header">
    <span>OnlyUs üíñ</span>
    <button id="callBtn">üìû</button>
  </div>

  <div id="messages" class="messages"></div>

  <div class="inputBar">
    <input id="msgInput" placeholder="Type message‚Ä¶">
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- INCOMING CALL -->
<div id="incoming">
  <div class="box">
    <h3>üìû Incoming Call</h3>
    <p id="callerText"></p>
    <button id="acceptBtn">Accept</button>
    <button id="rejectBtn">Reject</button>
  </div>
</div>

<!-- VIDEO CALL -->
<div id="videoBox">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
  <button id="endCall">End Call</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* üî• NEW FIREBASE CONFIG (REPLACED) */
firebase.initializeApp({
  apiKey: "AIzaSyDHYZDkcI0d7bm5CxXtSJQRhlhTkqL1Piw",
  authDomain: "onlyus-44a12.firebaseapp.com",
  databaseURL: "https://onlyus-44a12-default-rtdb.firebaseio.com",
  projectId: "onlyus-44a12",
  storageBucket: "onlyus-44a12.firebasestorage.app",
  messagingSenderId: "808673364331",
  appId: "1:808673364331:web:7e83c562a956f90a13e42e"
});

const db = firebase.database();
const room = new URLSearchParams(location.search).get("room") || "love";

/* TURN + STUN (ONE-WAY FIX) */
const rtcConfig = {
  iceServers:[
    {urls:"stun:stun.l.google.com:19302"},
    {
      urls:"turn:global.relay.metered.ca:80",
      username:"openai",
      credential:"openai"
    },
    {
      urls:"turn:global.relay.metered.ca:443",
      username:"openai",
      credential:"openai"
    }
  ]
};

let user, pc, localStream;
let isCalling = false;

/* LOGIN */
enterBtn.onclick = () => {
  user = nameInput.value.trim();
  if(!user) return alert("Enter name");

  login.style.display="none";
  chat.style.display="flex";

  db.ref(`calls/${room}`).remove(); // stale cleanup

  listenChat();
  listenCalls();
};

/* CHAT */
sendBtn.onclick = () => {
  if(!msgInput.value.trim()) return;
  db.ref(`rooms/${room}/msgs`).push({u:user,t:msgInput.value});
  msgInput.value="";
};

function listenChat(){
  db.ref(`rooms/${room}/msgs`).on("child_added",s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="msg "+(m.u===user?"me":"you");
    d.innerText=m.t;
    messages.appendChild(d);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* PEER */
async function createPeer(){
  pc = new RTCPeerConnection(rtcConfig);

  pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if(e.candidate){
      db.ref(`calls/${room}/ice`).push({
        by:user,
        c:e.candidate
      });
    }
  };

  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

/* CALL */
callBtn.onclick = async () => {
  isCalling = true;

  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;
  videoBox.style.display="block";

  await createPeer();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  db.ref(`calls/${room}`).set({
    from:user,
    offer:offer,
    status:"ringing",
    time:Date.now()
  });
};

/* LISTEN CALL */
function listenCalls(){
  db.ref(`calls/${room}`).on("value", async s=>{
    const c=s.val();
    if(!c) return;

    if(
      c.status==="ringing" &&
      c.offer &&
      c.from!==user &&
      !isCalling
    ){
      callerText.innerText = c.from + " is calling‚Ä¶";
      incoming.style.display="flex";
    }

    if(c.answer && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(c.answer));
    }
  });
}

/* ACCEPT */
acceptBtn.onclick = async () => {
  incoming.style.display="none";

  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;
  videoBox.style.display="block";

  await createPeer();

  const snap = await db.ref(`calls/${room}/offer`).get();
  await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  db.ref(`calls/${room}/answer`).set(answer);
  db.ref(`calls/${room}/status`).set("accepted");
};

/* REJECT */
rejectBtn.onclick = () => {
  incoming.style.display="none";
  db.ref(`calls/${room}`).remove();
};

/* ICE */
db.ref(`calls/${room}/ice`).on("child_added",s=>{
  const d=s.val();
  if(pc && d.by!==user){
    pc.addIceCandidate(new RTCIceCandidate(d.c));
  }
});

/* END CALL */
endCall.onclick = () => {
  if(pc) pc.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  isCalling=false;
  videoBox.style.display="none";
  db.ref(`calls/${room}`).remove();
};
</script>

</body>
</html>
